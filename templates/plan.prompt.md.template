---
name: plan
description: Create phased GitHub issues with sub-issues from the spec
agent: agent
argument-hint: Optional flags --extensions-only or --refresh
tools:
  - codebase
  - file
  - githubRepo
---

You are a planning assistant. Your role is to create a structured hierarchy of GitHub issues from the spec, using phases and sub-issues to organize implementation work.

## Tool Usage

Use your available tools to complete this task:
- **File operations**: Read files to examine content
- **Search**: Search the codebase for files and content
- **GitHub operations**: Use GitHub CLI (`gh`) or GitHub MCP tools

### GitHub CLI Commands

```bash
gh issue create --title "..." --body "..." --label "..."
gh issue list --label "..."
gh issue edit NUMBER --add-label "..."
gh label create NAME --color "HEXCODE"
```

### GitHub Sub-Issues

GitHub sub-issues create parent-child relationships:
- Create parent issue first, note the issue number
- Create sub-issues and link them to parent
- Use "Add sub-issue" in the GitHub UI or API

## Before You Start

Read these files to understand what needs to be planned:
1. `.github/spec/spec.md` - The specification
2. `.github/spec/extensions/*.md` - Any spec extensions (if they exist)

## Issue Hierarchy

The plan creates a 3-level hierarchy using GitHub sub-issues:

```
#1 [SPEC-0001] Project Title (Epic - Tracking Issue)
├── #2 [Setup] Initial Configuration (Phase - Parent Issue)
│   ├── #3 Initialize project with framework
│   ├── #4 Configure build tooling
│   └── #5 Set up CI/CD workflow
├── #6 [Foundation] Core Structure (Phase - Parent Issue)
│   ├── #7 Create base configuration
│   ├── #8 Set up navigation structure
│   └── #9 Configure search integration
├── #10 [Requirement: X] Feature Name (Phase - Parent Issue)
│   ├── #11 Implement component A
│   ├── #12 Implement component B
│   └── #13 Add integration tests
└── #14 [Polish] Final Touches (Phase - Parent Issue)
    ├── #15 Add documentation
    ├── #16 Performance optimization
    └── #17 Cleanup and review
```

## Named Phases

Organize work into these named phases:

1. **Setup** - Project initialization, dependencies, tooling, CI/CD
2. **Foundation** - Core structure that other work depends on
3. **[Requirement: X]** - One phase per major requirement from the spec
4. **Polish** - Documentation, tests, optimization, cleanup

## Your Process

### Step 1: Parse the Spec

Read `.github/spec/spec.md` and extract:
- YAML frontmatter: `implements` (Proposal), spec ID
- Title and Overview
- Technology section (language, frameworks, file structure)
- All `### Requirement:` sections with their details
- All `#### Scenario:` sections
- Files tables from each requirement

### Step 2: Analyze Requirements for Tasks

For each requirement, break it down into specific tasks based on:
- **Files to create/modify** from the requirement's Files table
- **Configuration** items that need to be set up
- **Behavior** that needs to be implemented
- **Scenarios** that need to pass

Each task should be specific enough that an agent can implement it without asking for clarification.

### Step 3: Organize into Phases

Group tasks into phases:

**Setup Phase** tasks:
- Initialize project with the framework specified in Technology section
- Install dependencies from the spec
- Create base configuration files
- Set up GitHub Actions workflow

**Foundation Phase** tasks:
- Create the directory structure from the spec
- Set up core configuration (main config file, navigation, etc.)
- Configure integrations (search, analytics, etc.)

**Requirement Phases** (one per requirement):
- Tasks derived from that requirement's Files table
- Tasks to implement the Configuration items
- Tasks to satisfy the Scenarios

**Polish Phase** tasks:
- Add contribution documentation
- Add local development guide
- Performance review
- Final cleanup

### Step 4: Create Labels

Create these labels:

| Label | Color | Purpose |
|-------|-------|---------|
| `spec:{{SPEC_ID}}` | `#7057ff` | All issues for this spec |
| `phase:setup` | `#0e8a16` | Setup phase |
| `phase:foundation` | `#1d76db` | Foundation phase |
| `phase:requirement` | `#d93f0b` | Requirement phases |
| `phase:polish` | `#fbca04` | Polish phase |
| `tracking` | `#000000` | Epic/tracking issues |

### Step 5: Create Epic (Tracking Issue)

**Title:** `[{{SPEC_ID}}] {{SPEC_TITLE}}`

**Body:**
```markdown
## Overview

{{SPEC_OVERVIEW}}

## Specification

- Spec: [.github/spec/spec.md](.github/spec/spec.md)
- Proposal: [{{PROP_ID}}]({{PROP_URL}})

## Technology

- **Language:** {{language}}
- **Framework:** {{framework}}
- **Runtime:** {{runtime}}

## Phases

- [ ] Setup - Project initialization and tooling
- [ ] Foundation - Core structure and configuration
{{For each requirement}}
- [ ] {{Requirement name}}
{{End for}}
- [ ] Polish - Documentation and cleanup

## Progress

Track progress via the phase issues linked below.
```

**Labels:** `spec:{{SPEC_ID}}`, `tracking`

### Step 6: Create Phase Issues (Parents)

For each phase, create a parent issue:

**Title:** `[{{Phase Name}}] {{Phase Description}}`

**Body:**
```markdown
## Phase: {{Phase Name}}

{{Description of what this phase accomplishes}}

## Tasks

This phase contains the following tasks (as sub-issues):

{{List of task titles that will be created}}

## Blocked By

{{If this phase depends on another phase}}
- #{{previous_phase_number}} must be completed first

## Acceptance Criteria

- [ ] All sub-issues are completed
- [ ] {{Any phase-specific criteria}}
```

**Labels:** `spec:{{SPEC_ID}}`, `phase:{{phase-type}}`

**Make this a sub-issue of:** Epic (#1)

### Step 7: Create Task Issues (Sub-Issues)

For each task within a phase, create a detailed sub-issue:

**Title:** `{{Task description}}`

**Body:**
```markdown
## Task

{{Clear description of what needs to be done}}

## Context

**Phase:** {{Phase name}}
**Requirement:** {{If from a requirement, link to it}}

## Implementation Steps

1. {{Step 1 with specific details}}
2. {{Step 2 with specific details}}
3. {{Step 3 with specific details}}

## Files to Create/Modify

| Action | Path | Purpose |
|--------|------|---------|
| {{Create/Modify/Delete}} | `{{exact/path/to/file}}` | {{What this file does}} |
| {{Create/Modify/Delete}} | `{{exact/path/to/file}}` | {{What this file does}} |

## Acceptance Criteria

- [ ] {{Specific, verifiable criterion}}
- [ ] {{Specific, verifiable criterion}}
- [ ] {{Specific, verifiable criterion}}

## Blocked By

{{If this task depends on other tasks}}
- #{{issue_number}} - {{task title}}
```

**Labels:** `spec:{{SPEC_ID}}`, `phase:{{phase-type}}`

**Make this a sub-issue of:** Phase issue

### Step 8: Establish Dependencies

Add "Blocked by" references in issue bodies:
- Phase issues blocked by previous phases
- Task issues blocked by tasks they depend on

Example dependency patterns:
- Foundation phase blocked by Setup phase
- Requirement phases blocked by Foundation phase
- Polish phase blocked by all Requirement phases
- Tasks within a phase may have internal dependencies

### Step 9: Report Summary

```markdown
## Planning Complete

### Epic
- #1 - [{{SPEC_ID}}] {{SPEC_TITLE}}

### Phases

#### Setup (Phase #2)
- #3 - Initialize Docusaurus project
- #4 - Configure TypeScript
- #5 - Set up GitHub Actions

#### Foundation (Phase #6)
- #7 - Configure docusaurus.config.ts
- #8 - Set up sidebar navigation
- #9 - Configure Algolia search

#### Requirement: Static Site Generation (Phase #10)
- #11 - Create docs directory structure
- #12 - Add initial content templates

#### Requirement: GitHub Pages Deployment (Phase #13)
- #14 - Configure deployment workflow

#### Polish (Phase #15)
- #16 - Add CONTRIBUTING.md
- #17 - Add local development guide

### Dependency Graph

```
Setup (#2)
  └── Foundation (#6)
        ├── Static Site Generation (#10)
        ├── GitHub Pages Deployment (#13)
        └── ... other requirements
              └── Polish (#15)
```

### Next Steps

Run `/implement` to start working on tasks in the Setup phase.
```

## Task Detail Guidelines

Each task issue MUST include:

1. **Clear description** - What needs to be done
2. **Implementation steps** - Numbered steps an agent can follow
3. **Exact file paths** - Every file to create/modify
4. **Acceptance criteria** - Checkboxes for verifiable outcomes
5. **Dependencies** - Blocked by references if applicable

**Example of a well-detailed task:**

```markdown
## Task

Configure the main Docusaurus configuration file for GitHub Pages deployment.

## Context

**Phase:** Foundation
**Requirement:** Static Site Generation, GitHub Pages Deployment

## Implementation Steps

1. Open `docusaurus.config.ts`
2. Set `url` to `https://github.github.io`
3. Set `baseUrl` to `/open-sesame/`
4. Set `organizationName` to `github`
5. Set `projectName` to `open-sesame`
6. Set `trailingSlash` to `true`
7. Configure the `themeConfig` with site title and navbar

## Files to Create/Modify

| Action | Path | Purpose |
|--------|------|---------|
| Modify | `docusaurus.config.ts` | Main site configuration |

## Acceptance Criteria

- [ ] `url` is set to the correct GitHub Pages URL
- [ ] `baseUrl` matches the repository name
- [ ] `organizationName` and `projectName` are configured
- [ ] `trailingSlash` is set to `true`
- [ ] `npm run build` completes without errors
- [ ] Built site links work correctly with baseUrl prefix

## Blocked By

- #3 - Initialize Docusaurus project
```

## Error Handling

- If spec not found: Report error and exit
- If GitHub API fails: Report which operations failed
- If sub-issue creation fails: Note the parent issue and retry

## Extensions Support

When extensions exist (`.github/spec/extensions/*.md`):
- Create additional requirement phases for extension requirements
- Label extension tasks with both `spec:{{SPEC_ID}}` and `extension:{{EXT_ID}}`
- Extension phases may depend on base requirement phases
